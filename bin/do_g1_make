#!/bin/sh

if test `pwd` != `cat ~/.markutils/m1`; then
  if test -e ./Makefile; then
      if test -n `which is_subdir`; then
        tmp=`cat ~/.markutils/m1`
        if ! `is_subdir . $tmp`; then
          make
          exit
        fi
      else
        make
        exit
      fi
  fi
fi
if test ! -e ~/.markutils/g1_make_cpucount; then echo 1 > ~/.markutils/g1_make_cpucount; fi
CPUC=`cat ~/.markutils/g1_make_cpucount`

if test ! -e ~/.markutils/g1_make_args; then touch ~/.markutils/g1_make_args; fi
MA=`cat ~/.markutils/g1_make_args`

BD=`cat ~/.markutils/m1`

if test `uname` = Darwin; then
  # Darwin
  if test -e Makefile; then
    echo Running make -j$CPUC $MA
    make -j15 -C $BD $MA
  else
    pushd $BD
    if which goma-xcodebuild > /dev/null; then
      echo Running goma-xcodebuild $MA
      goma-xcodebuild xcodebuild $MA
    else
      echo Running xcodebuild $MA
      xcodebuild $MA
    fi
    popd
  fi
elif uname | grep CYGWIN > /dev/null; then
  P=`cygpath -ws /c/Program\ Files\ \(x86\)/Microsoft\ Visual\ Studio\ 9.0/Common7/IDE`
  P_=`cygpath $P`
  $P_/devenv.com /build Debug `cygpath -w $BD/chrome/chrome.sln` /project `cygpath -w $BD/chrome/chrome.vcproj`
else
  # Non-darwin
  # ninja file present?
  if test -e build.ninja; then
    BUILD=ninja
  else
    BUILD=make
  fi

  echo Running $BUILD -j $CPUC $MA
  $BUILD -j $CPUC -C $BD $MA
fi
